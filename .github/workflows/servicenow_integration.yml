name: ServiceNow Integration

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

env:
  SERVICENOW_PRODUCT: "WSO2 API Manager 1.10.0 Developer Portal"
  SERVICENOW_PROJECT: "Customer Portal Customer Project1 - Subscription"

jobs:
  send-to-servicenow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Parse Issue Form Fields
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            console.log('Parsing issue form data...');
            console.log('Issue body length:', body.length);
            
            // Parse GitHub issue form format
            function extractField(body, fieldLabel) {
              const regex = new RegExp(`###\\s*${fieldLabel}\\s*\\n\\n([\\s\\S]*?)(?=\\n\\n###|$)`, 'i');
              const match = body.match(regex);
              const value = match ? match[1].trim() : '';
              
              if (value === '_No response_' || value === 'No response' || value === '') {
                return '';
              }
              
              return value;
            }
            
            // Extract all fields
            const fields = {
              template_marker: extractField(body, 'Template Marker'),
              catalog_item: extractField(body, 'ServiceNow Catalog Item') || 
                           extractField(body, 'ServiceNow Catalog'),
              case_type: extractField(body, 'Case Type'),
              u_request_details: extractField(body, 'Request Details') || 
                                 extractField(body, 'Request Summary') ||
                                 extractField(body, 'Issue Summary') ||
                                 extractField(body, 'Access Details'),
              description: extractField(body, 'Detailed Description') ||
                          extractField(body, 'Description') ||
                          extractField(body, 'Business Justification'),
              priority: extractField(body, 'Priority') || 
                       extractField(body, 'Severity'),
              u_project_environment: extractField(body, 'Environment Details') ||
                                    extractField(body, 'Environment(s)') ||
                                    extractField(body, 'Affected Environments')
            };
            
            console.log('üì¶ Extracted fields:', JSON.stringify(fields, null, 2));
            
            // ============================================================
            // VALIDATION
            // ============================================================
            if (!fields.catalog_item) {
              core.setFailed('‚ùå Catalog item not found in template');
              return;
            }
            
            if (!fields.u_request_details) {
              core.setFailed('‚ùå Request details not found in template');
              return;
            }
            
            // ============================================================
            // CASE TYPE DETERMINATION
            // ============================================================
            let caseType = fields.case_type;
            
            if (!caseType) {
              const labels = context.payload.issue.labels.map(l => l.name);
              console.log('üè∑Ô∏è Labels:', labels);
              
              if (labels.some(l => l.includes('Type/Incident') || l.includes('bug'))) {
                caseType = 'Incident';
              } else if (labels.some(l => l.includes('Type/Query'))) {
                caseType = 'Query';
              } else if (labels.some(l => l.includes('Type/ServiceRequest'))) {
                caseType = 'Service Request';
              } else {
                caseType = 'Service Request';
              }
              
              console.log('‚ö†Ô∏è  Case type not in template, derived from labels:', caseType);
            } else {
              console.log('‚úì Case type from template:', caseType);
            }
            
            fields.case_type = caseType;
            
            // ============================================================
            // PARSE ENVIRONMENTS
            // ============================================================
            if (fields.u_project_environment) {
              fields.u_project_environment = fields.u_project_environment
                .split(',')
                .map(env => env.trim())
                .filter(env => env.length > 0)
                .join(', ');
              
              console.log('‚úì Parsed environments:', fields.u_project_environment);
            } else {
              fields.u_project_environment = 'Development';
            }
            
            // ============================================================
            // MAP PRIORITY
            // ============================================================
            const priorityMap = {
              'Critical': '1 - Critical',
              'Critical (System Down)': '1 - Critical',
              'High': '2 - High',
              'High (Major Impact)': '2 - High',
              'Moderate': '3 - Moderate',
              'Moderate (Minor Impact)': '3 - Moderate',
              'Low': '4 - Low',
              'Low (Cosmetic)': '4 - Low'
            };
            
            if (fields.priority && priorityMap[fields.priority]) {
              fields.priority = priorityMap[fields.priority];
              console.log('‚úì Mapped priority:', fields.priority);
            } else {
              fields.priority = '3 - Moderate';
              console.log('‚ÑπÔ∏è Using default priority:', fields.priority);
            }
            
            // Set all outputs
            for (const [key, value] of Object.entries(fields)) {
              core.setOutput(key, value || '');
            }
            
            console.log('‚úÖ Parsing complete');
            console.log('Summary:');
            console.log('   Template:', fields.template_marker);
            console.log('   Catalog:', fields.catalog_item);
            console.log('   Case Type:', fields.case_type);
            console.log('   Priority:', fields.priority);

      - name: Build ServiceNow Payload
        id: build_payload
        run: |
          echo "Building ServiceNow payload..."
          
          CATALOG_ITEM="${{ steps.parse.outputs.catalog_item }}"
          CASE_TYPE="${{ steps.parse.outputs.case_type }}"
          U_REQUEST_DETAILS="${{ steps.parse.outputs.u_request_details }}"
          DESCRIPTION="${{ steps.parse.outputs.description }}"
          PRIORITY="${{ steps.parse.outputs.priority }}"
          ENVIRONMENTS="${{ steps.parse.outputs.u_project_environment }}"
          
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE='${{ github.event.issue.title }}'
          ISSUE_URL="${{ github.event.issue.html_url }}"
          GITHUB_USER="${{ github.event.issue.user.login }}"
          REPO_FULL_NAME="${{ github.repository }}"
          LABELS="${{ join(github.event.issue.labels.*.name, ', ') }}"
          
          PRODUCT="${{ env.SERVICENOW_PRODUCT }}"
          PROJECT="${{ env.SERVICENOW_PROJECT }}"
          
          echo "Payload Summary:"
          echo "  ‚îú‚îÄ Catalog Item: $CATALOG_ITEM"
          echo "  ‚îú‚îÄ Case Type: $CASE_TYPE"
          echo "  ‚îú‚îÄ Priority: $PRIORITY"
          echo "  ‚îú‚îÄ Environments: $ENVIRONMENTS"
          echo "  ‚îú‚îÄ Project: $PROJECT (auto-mapped)"
          echo "  ‚îî‚îÄ Product: $PRODUCT (auto-mapped)"
          
          PAYLOAD=$(jq -n \
            --arg catalog_item "$CATALOG_ITEM" \
            --arg case_type "$CASE_TYPE" \
            --arg u_request_details "$U_REQUEST_DETAILS" \
            --arg description "$DESCRIPTION" \
            --arg priority "$PRIORITY" \
            --arg environments "$ENVIRONMENTS" \
            --arg project "$PROJECT" \
            --arg product "$PRODUCT" \
            --arg title "$ISSUE_TITLE" \
            --arg issue_number "$ISSUE_NUMBER" \
            --arg issue_url "$ISSUE_URL" \
            --arg github_user "$GITHUB_USER" \
            --arg repository_full_name "$REPO_FULL_NAME" \
            --arg labels "$LABELS" \
            '{
              catalog_item: $catalog_item,
              case_type: $case_type,
              u_request_details: $u_request_details,
              description: $description,
              priority: $priority,
              u_project_environment: $environments,
              project: $project,
              product: $product,
              title: $title,
              issue_number: $issue_number,
              issue_url: $issue_url,
              github_user: $github_user,
              repository_full_name: $repository_full_name,
              labels: $labels
            }')
          
          echo "$PAYLOAD" > payload.json
          echo ""
          echo "Final Payload:"
          cat payload.json | jq '.'
          echo ""
          echo "‚úÖ Payload built successfully"

      - name: Send to ServiceNow
        id: send_servicenow
        run: |
          SERVICENOW_URL="https://wso2sndev.service-now.com/api/wso2/test_sr"
          
          echo "Sending to ServiceNow: $SERVICENOW_URL"
          echo ""
          
          HTTP_CODE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-WSO2/1.0" \
            -d @payload.json \
            -w "%{http_code}" \
            -o response.json \
            -s \
            "$SERVICENOW_URL")
          
          echo "HTTP Status: $HTTP_CODE"
          echo ""
          echo "ServiceNow Response:"
          cat response.json | jq '.' || cat response.json
          echo ""
          
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Successfully created case in ServiceNow"
            
            CASE_NUMBER=$(cat response.json | jq -r '.result.case_number // empty')
            echo "case_number=$CASE_NUMBER" >> $GITHUB_OUTPUT
            
            exit 0
          else
            echo "‚ùå Failed to create case (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Comment on Issue - Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let response = {};
            
            try {
              response = JSON.parse(fs.readFileSync('response.json', 'utf8'));
              if (response.result) response = response.result;
            } catch (e) {}
            
            const caseNumber = response.case_number || 'Unknown';
            const caseType = '${{ steps.parse.outputs.case_type }}';
            const catalogItem = '${{ steps.parse.outputs.catalog_item }}';
            const priority = '${{ steps.parse.outputs.priority }}';
            const environments = '${{ steps.parse.outputs.u_project_environment }}';
            
            const commentBody = `## ‚úÖ ServiceNow Case Created Successfully

            **Case Number:** \`${caseNumber}\`

            ### Request Details
            - **Type:** ${caseType}
            - **Catalog:** ${catalogItem}
            - **Priority:** ${priority}
            - **Environments:** ${environments}

            ### Auto-Mapped Fields
            - **Project:** ${{ env.SERVICENOW_PROJECT }}
            - **Product:** ${{ env.SERVICENOW_PRODUCT }}

            ---
            *Your ${caseType.toLowerCase()} has been submitted and will be processed by the support team.*

            *Automated via GitHub Actions*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

      - name: Comment on Issue - Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = `## ‚ùå ServiceNow Case Creation Failed

            Failed to create case in ServiceNow.

            **Debug Information:**
            - **Catalog:** ${{ steps.parse.outputs.catalog_item }}
            - **Case Type:** ${{ steps.parse.outputs.case_type }}

            Check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for detailed error messages.

            ---
            *Contact support if the issue persists. Reference issue #${context.issue.number}*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });