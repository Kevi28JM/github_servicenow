name: ServiceNow Integration (Fully Dynamic)

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

env:
  SERVICENOW_PRODUCT: "WSO2 API Manager 1.10.0 Developer Portal"
  SERVICENOW_PROJECT: "Customer Portal Customer Project1 - Subscription"

jobs:
  send-to-servicenow:
    runs-on: ubuntu-latest
    steps:

      - name: Extract All Fields Dynamically
        id: extract_fields
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            console.log('='.repeat(80));
            console.log('FULLY DYNAMIC FIELD EXTRACTOR');
            console.log('='.repeat(80));
            console.log('Issue body length:', body.length);
            
            // ============================================================
            // EXTRACT ALL FIELDS AUTOMATICALLY
            // ============================================================
            function extractAllFields(body) {
              const fields = {};
              
              // Regex to match: ### FieldName\n\nValue
              const regex = /###\s+([^\n]+)\s*\n+([^\n][\s\S]*?)(?=\n+###|\n*$)/g;
              
              let match;
              let count = 0;
              
              while ((match = regex.exec(body)) !== null) {
                const label = match[1].trim();
                const value = match[2].trim();
                
                // Skip empty or "No response" values
                if (!value || value === '_No response_' || value === 'No response') {
                  console.log(`âŠ— Skipping empty: ${label}`);
                  continue;
                }
                
                // Convert label to field ID
                const normalizedLabel = label.toLowerCase();
                
                // Known field mappings for metadata
                const knownFields = {
                  'template marker': 'template_marker',
                  'servicenow catalog item': 'catalog_item',
                  'catalog item': 'catalog_item',
                  'case type': 'case_type',
                  'priority': 'priority',
                  'severity': 'priority',
                  'short description': 'u_short_description',
                  'description': 'description',
                  'detailed description': 'description',
                  'impact': 'u_impact',
                  'impact description (overall)': 'u_impact_description_overall',
                  'impact description (customer)': 'u_impact_description_customer',
                  'environment details': 'u_project_environment',
                  'environment': 'u_project_environment',
                  'affected component': 'u_affected_component',
                  'affected services': 'u_affected_services',
                  'service outage/downtime': 'u_service_outage',
                  'is a maintenance window required or not': 'u_maintenance_window',
                  'maintenance window': 'u_maintenance_window',
                  'implementation plan': 'u_implementation_plan',
                  'test plan': 'u_test_plan',
                  'monitoring checks': 'u_monitoring_checks',
                  'request details': 'u_request_details'
                };
                
                let fieldId;
                
                if (knownFields[normalizedLabel]) {
                  // Use known mapping
                  fieldId = knownFields[normalizedLabel];
                  console.log(`âœ“ [${++count}] "${label}" â†’ ${fieldId} (mapped)`);
                } else {
                  // Auto-generate field ID with u_ prefix
                  fieldId = 'u_' + label
                    .replace(/[^\w\s-]/g, '')  // Remove special chars
                    .trim()
                    .toLowerCase()
                    .replace(/\s+/g, '_')      // Spaces to underscores
                    .replace(/^u_+/, '');      // Remove duplicate u_
                  
                  console.log(`âœ“ [${++count}] "${label}" â†’ ${fieldId} (auto-generated)`);
                }
                
                fields[fieldId] = value;
              }
              
              return fields;
            }
            
            const allFields = extractAllFields(body);
            
            console.log(`\nğŸ“¦ Extracted ${Object.keys(allFields).length} fields`);
            console.log('\n' + '-'.repeat(80));
            console.log('ALL FIELDS:');
            console.log(JSON.stringify(allFields, null, 2));
            console.log('-'.repeat(80));
            
            // ============================================================
            // IDENTIFY CONTROL FIELDS
            // ============================================================
            const catalogItem = allFields.servicenow_catalog_item || 
                               allFields.catalog_item || 
                               'General Requests';
            
            const caseType = allFields.case_type || 'Service Request';
            const priority = allFields.priority || 'Moderate';
            const environment = allFields.u_project_environment || 'Development';
            
            console.log('\nğŸ¯ Control Fields:');
            console.log('  Catalog:', catalogItem);
            console.log('  Case Type:', caseType);
            console.log('  Priority:', priority);
            console.log('  Environment:', environment);
            
            // ============================================================
            // MAP PRIORITY
            // ============================================================
            const priorityMap = {
              'Critical': '1 - Critical',
              'High': '2 - High',
              'Moderate': '3 - Moderate',
              'Low': '4 - Low'
            };
            
            const mappedPriority = priorityMap[priority] || '3 - Moderate';
            allFields.priority = mappedPriority;
            
            console.log('  Mapped Priority:', mappedPriority);
            
            // ============================================================
            // PARSE ENVIRONMENTS (if multiple)
            // ============================================================
            if (environment) {
              const parsedEnv = environment
                .split(',')
                .map(e => e.trim())
                .filter(e => e.length > 0)
                .join(', ');
              
              allFields.u_project_environment = parsedEnv;
              console.log('  Parsed Environment:', parsedEnv);
            }
            
            // ============================================================
            // SET OUTPUTS
            // ============================================================
            core.setOutput('all_fields', JSON.stringify(allFields));
            core.setOutput('catalog_item', catalogItem);
            core.setOutput('case_type', caseType);
            core.setOutput('priority', mappedPriority);
            core.setOutput('environment', environment);
            
            console.log('\nâœ… Dynamic extraction complete!');
            console.log('='.repeat(80));

      - name: Build Dynamic Payload
        id: build_payload
        run: |
          echo "Building fully dynamic payload..."
          
          # Get all extracted fields
          ALL_FIELDS='${{ steps.extract_fields.outputs.all_fields }}'
          
          # GitHub metadata
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE='${{ github.event.issue.title }}'
          ISSUE_URL="${{ github.event.issue.html_url }}"
          GITHUB_USER="${{ github.event.issue.user.login }}"
          REPO_FULL_NAME="${{ github.repository }}"
          LABELS="${{ join(github.event.issue.labels.*.name, ', ') }}"
          
          # Environment variables
          PRODUCT="${{ env.SERVICENOW_PRODUCT }}"
          PROJECT="${{ env.SERVICENOW_PROJECT }}"
          
          echo "ğŸ“‹ Payload Summary:"
          echo "  â”œâ”€ Catalog: ${{ steps.extract_fields.outputs.catalog_item }}"
          echo "  â”œâ”€ Case Type: ${{ steps.extract_fields.outputs.case_type }}"
          echo "  â”œâ”€ Priority: ${{ steps.extract_fields.outputs.priority }}"
          echo "  â”œâ”€ Environment: ${{ steps.extract_fields.outputs.environment }}"
          echo "  â”œâ”€ Fields: $(echo "$ALL_FIELDS" | jq 'length') total"
          echo "  â”œâ”€ Project: $PROJECT"
          echo "  â””â”€ Product: $PRODUCT"
          
          # Create a simple HTML formatted description (like your example)
          FORMATTED_DESCRIPTION=$(echo "$ALL_FIELDS" | jq -r '
            "<strong>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</strong><br/>" +
            "<strong>GITHUB ISSUE #${{ github.event.issue.number }}: ${{ github.event.issue.title }}</strong><br/>" +
            "<strong>URL:</strong> <a href=\"${{ github.event.issue.html_url }}\" target=\"_blank\">${{ github.event.issue.html_url }}</a><br/>" +
            "<strong>Created by:</strong> ${{ github.event.issue.user.login }}<br/>" +
            "<strong>Repository:</strong> ${{ github.repository }}<br/>" +
            "<strong>Labels:</strong> ${{ join(github.event.issue.labels.*.name, \", \") }}<br/>" +
            "<strong>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</strong><br/><br/>" +
            (to_entries | map(
              "<strong>" + (.key | gsub("^u_"; "") | gsub("_"; " ") | ascii_upcase) + ":</strong><br/>" +
              (.value | gsub("\n"; "<br/>")) + "<br/><br/>"
            ) | join("")) +
            "<br/><strong>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</strong><br/>" +
            "<strong>Automated via GitHub Actions</strong><br/>" +
            "<strong>Workflow Run:</strong> ${{ github.run_id }}"
          ')
          
          # Merge all fields with GitHub metadata + formatted description
          PAYLOAD=$(echo "$ALL_FIELDS" | jq \
            --arg project "$PROJECT" \
            --arg product "$PRODUCT" \
            --arg title "$ISSUE_TITLE" \
            --arg issue_number "$ISSUE_NUMBER" \
            --arg issue_url "$ISSUE_URL" \
            --arg github_user "$GITHUB_USER" \
            --arg repository_full_name "$REPO_FULL_NAME" \
            --arg labels "$LABELS" \
            --arg formatted_description "$FORMATTED_DESCRIPTION" \
            '. + {
              project: $project,
              product: $product,
              title: $title,
              issue_number: $issue_number,
              issue_url: $issue_url,
              github_user: $github_user,
              repository_full_name: $repository_full_name,
              labels: $labels,
              description: $formatted_description
            }')
          
          echo "$PAYLOAD" > payload.json
          
          echo ""
          echo "ğŸ“¦ Final Payload:"
          cat payload.json | jq '.'
          echo ""
          echo "âœ… Dynamic payload built successfully"

      - name: Send to ServiceNow
        id: send_servicenow
        run: |
          SERVICENOW_URL="https://wso2sndev.service-now.com/api/wso2/test_sr"
          
          echo "ğŸ“¤ Sending to ServiceNow: $SERVICENOW_URL"
          echo ""
          
          HTTP_CODE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-WSO2/1.0" \
            -d @payload.json \
            -w "%{http_code}" \
            -o response.json \
            -s \
            "$SERVICENOW_URL")
          
          echo "HTTP Status: $HTTP_CODE"
          echo ""
          echo "ServiceNow Response:"
          cat response.json | jq '.' || cat response.json
          echo ""
          
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Successfully created case in ServiceNow"
            
            # Extract case number from response
            CASE_NUMBER=$(cat response.json | jq -r '.result.case_number // .case_number // empty')
            echo "case_number=$CASE_NUMBER" >> $GITHUB_OUTPUT
            
            if [ -n "$CASE_NUMBER" ]; then
              echo "ğŸ“‹ Case Number: $CASE_NUMBER"
            fi
            
            exit 0
          else
            echo "âŒ Failed to create case (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Comment on Issue - Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let response = {};
            
            try {
              response = JSON.parse(fs.readFileSync('response.json', 'utf8'));
              if (response.result) response = response.result;
            } catch