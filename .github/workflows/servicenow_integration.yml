name: ServiceNow Integration - FIXED

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  send-to-servicenow:
    runs-on: ubuntu-latest
    steps:

      - name: Check GitHub Actions IP
        run: |
          echo "GitHub Actions IP Address:"
          curl https://api.ipify.org
          echo ""

      - name: Send Custom Payload to ServiceNow
        run: |
          # Extract GitHub issue data
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE=$(echo '${{ toJSON(github.event.issue.title) }}' | jq -r '.')
          ISSUE_BODY=$(echo '${{ toJSON(github.event.issue.body) }}' | jq -r '.')
          ISSUE_URL="${{ github.event.issue.html_url }}"
          GITHUB_USER="${{ github.event.issue.user.login }}"
          REPO_NAME="${{ github.event.repository.name }}"
          REPO_FULL_NAME="${{ github.event.repository.full_name }}"
          
          # Extract labels as array
          LABELS_JSON='${{ toJSON(github.event.issue.labels) }}'
          
          # Extract labels as comma-separated string (for your flat format)
          LABELS=$(echo "$LABELS_JSON" | jq -r '.[].name' | tr '\n' ',' | sed 's/,$//')
          
          # Determine environment from labels
          ENVIRONMENT="Development"
          if echo "$LABELS" | grep -qi "production\|prod"; then
            ENVIRONMENT="Production"
          elif echo "$LABELS" | grep -qi "staging\|stage"; then
            ENVIRONMENT="Staging"
          fi
          
          # Determine priority from labels
          PRIORITY="3 - Moderate"
          if echo "$LABELS" | grep -qi "high-priority\|critical"; then
            PRIORITY="1 - Critical"
          elif echo "$LABELS" | grep -qi "medium-priority"; then
            PRIORITY="2 - High"
          fi
          
          # Determine case type from labels
          CASE_TYPE="Service Request"
          if echo "$LABELS" | grep -qi "bug\|incident"; then
            CASE_TYPE="Incident"
          fi
          
          # Map repo to project/product
          PROJECT="Customer Portal Customer Project1 - Subscription"
          PRODUCT="WSO2 API Manager 1.10.0 Developer Portal"
          WSO2_PRODUCT="WSO2 API Manager Analytics"
          
          # ============================================
          # FIXED: Now includes "action" field at top level
          # AND properly structured to match your ServiceNow script
          # ============================================
          
          CUSTOM_PAYLOAD=$(jq -n \
            --arg action "opened" \
            --argjson issue_number "$ISSUE_NUMBER" \
            --arg issue_title "$ISSUE_TITLE" \
            --arg issue_body "$ISSUE_BODY" \
            --arg issue_url "$ISSUE_URL" \
            --arg github_user "$GITHUB_USER" \
            --arg repo_name "$REPO_NAME" \
            --arg repo_full_name "$REPO_FULL_NAME" \
            --argjson labels "$LABELS_JSON" \
            --arg project "$PROJECT" \
            --arg product "$PRODUCT" \
            --arg wso2_product "$WSO2_PRODUCT" \
            --arg environment "$ENVIRONMENT" \
            --arg case_type "$CASE_TYPE" \
            --arg priority "$PRIORITY" \
            --arg labels_string "$LABELS" \
            '{
              action: $action,
              issue: {
                number: $issue_number,
                title: $issue_title,
                body: $issue_body,
                html_url: $issue_url,
                user: {
                  login: $github_user
                },
                labels: $labels
              },
              repository: {
                name: $repo_name,
                full_name: $repo_full_name
              }
            }')
          
          echo "Custom Payload:"
          echo "$CUSTOM_PAYLOAD" | jq '.'
          
          # Send to ServiceNow
          HTTP_CODE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -d "$CUSTOM_PAYLOAD" \
            -w "%{http_code}" \
            -o response.json \
            -s \
            https://wso2sndev.service-now.com/api/wso2/test_sr)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "ServiceNow Response:"
          cat response.json | jq '.' || cat response.json
          
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Successfully created case in ServiceNow"
            
            # Extract case details from response
            CASE_NUMBER=$(cat response.json | jq -r '.case_number // empty')
            REQUEST_NUMBER=$(cat response.json | jq -r '.request_number // empty')
            RITM_NUMBER=$(cat response.json | jq -r '.ritm_number // empty')
            
            if [ -n "$CASE_NUMBER" ]; then
              echo "üìã Case Number: $CASE_NUMBER"
            fi
            if [ -n "$REQUEST_NUMBER" ]; then
              echo "üìã Request Number: $REQUEST_NUMBER"
            fi
            if [ -n "$RITM_NUMBER" ]; then
              echo "üìã RITM Number: $RITM_NUMBER"
            fi
            
            exit 0
          else
            echo "‚ùå Failed to create case (HTTP $HTTP_CODE)"
            cat response.json
            exit 1
          fi
      
      - name: Comment on Issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let response = {};
            try {
              response = JSON.parse(fs.readFileSync('response.json', 'utf8'));
            } catch (e) {
              response = {};
            }
            
            let recordsInfo = '';
            if (response.request_number) recordsInfo += `- **Request:** ${response.request_number}\n`;
            if (response.ritm_number) recordsInfo += `- **RITM:** ${response.ritm_number}\n`;
            if (response.case_number) recordsInfo += `- **Case:** ${response.case_number}\n`;
            
            if (!recordsInfo) {
              recordsInfo = '- Check ServiceNow for created records';
            }
            
            const comment = `## ‚úÖ ServiceNow Integration Complete
            
            Successfully sent issue to ServiceNow!
            
            ###  Created Records
            ${recordsInfo}
            
            ###  Links
            - **GitHub Issue:** #${{ github.event.issue.number }}
            - **Repository:** ${{ github.repository }}
            
            ---
            *Automated via GitHub Actions*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });