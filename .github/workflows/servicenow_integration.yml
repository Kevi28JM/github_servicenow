name: ServiceNow Integration

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

env:
  SERVICENOW_URL: "https://wso2sndev.service-now.com/api/wso2/test_sr" 
  SERVICENOW_PRODUCT: "WSO2 API Manager 1.10.0 Developer Portal"
  SERVICENOW_PROJECT: "Customer Portal Customer Project1 - Subscription"

jobs:
  send-to-servicenow:
    runs-on: ubuntu-latest
    
    steps:
      
      # ============================================================
      # Parse Issue Form and Build Payload
      # ============================================================
      - name: Parse Issue Form to JSON
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            console.log('üìã Parsing issue form to JSON...');
            console.log('üìÑ Body length:', body.length);
            console.log('üìÑ RAW BODY:');
            console.log(body);
            console.log('='.repeat(80));
            
            // ============================================================
            // FIELD EXTRACTION
            // ============================================================
            function extractFields(body) {
              const fields = {};
              
              // Simple regex - capture field IDs directly
              const regex = /###\s+([\w]+)\s*\n\n([\s\S]*?)(?=\n\n###|\n*$)/g;
              
              let match;
              while ((match = regex.exec(body)) !== null) {
                const fieldId = match[1];
                const value = match[2].trim();
                
                // Skip empty values
                if (!value || value === '_No response_' || value === 'No response') {
                  continue;
                }
                
                fields[fieldId] = value;
                console.log(`‚úì ${fieldId}`);
              }
              
              return fields;
            }

            // Extract all fields
            const allFields = extractFields(body);
            
            console.log(`\nüì¶ Extracted ${Object.keys(allFields).length} fields`);
            
            // ============================================================
            // CONTROL FIELD EXTRACTION
            // ============================================================
            const catalogItem = 
              allFields.servicenow_catalog_item || 
              allFields.catalog_item ||
              '';
            
            const caseType = allFields.case_type || '';
            const priority = allFields.priority || '';
            const environment = 
              allFields.u_project_environment ||
              allFields.environment_details ||
              allFields.environment ||
              '';
            
            // ============================================================
            // VALIDATION
            // ============================================================
            if (!catalogItem) {
              core.setFailed('‚ùå Catalog item not found. Make sure your template has a "servicenow_catalog_item" field.');
              return;
            }
            
            // ============================================================
            // CASE TYPE FALLBACK
            // ============================================================
            let finalCaseType = caseType;
            
            if (!finalCaseType) {
              const labels = context.payload.issue.labels.map(l => l.name);
              console.log('\nüè∑Ô∏è Labels:', labels);
              
              if (labels.some(l => l.includes('Type/Incident') || l.includes('bug'))) {
                finalCaseType = 'Incident';
              } else if (labels.some(l => l.includes('Type/Query'))) {
                finalCaseType = 'Query';
              } else if (labels.some(l => l.includes('Type/ServiceRequest'))) {
                finalCaseType = 'Service Request';
              } else {
                finalCaseType = 'Service Request';
              }
              
              console.log('‚ö†Ô∏è Case type not in template, derived from labels:', finalCaseType);
            } else {
              console.log('‚úì Case type from template:', finalCaseType);
            }
            
            // ============================================================
            // PARSE ENVIRONMENTS
            // ============================================================
            let finalEnvironment = environment;
            
            if (finalEnvironment) {
              finalEnvironment = finalEnvironment
                .split(',')
                .map(env => env.trim())
                .filter(env => env.length > 0)
                .join(', ');
              
              console.log('‚úì Parsed environments:', finalEnvironment);
            } else {
              finalEnvironment = 'Development';
              console.log('‚ÑπÔ∏è No environment specified, using default: Development');
            }
            
            // ============================================================
            // MAP PRIORITY
            // ============================================================
            const priorityMap = {
              'Critical': '1 - Critical',
              'Critical (System Down)': '1 - Critical',
              'High': '2 - High',
              'High (Major Impact)': '2 - High',
              'Moderate': '3 - Moderate',
              'Moderate (Minor Impact)': '3 - Moderate',
              'Low': '4 - Low',
              'Low (Cosmetic)': '4 - Low'
            };
            
            let finalPriority = priority;
            
            if (finalPriority && priorityMap[finalPriority]) {
              finalPriority = priorityMap[finalPriority];
              console.log('‚úì Mapped priority:', finalPriority);
            } else if (!finalPriority) {
              finalPriority = '3 - Moderate';
              console.log('‚ÑπÔ∏è No priority specified, using default: 3 - Moderate');
            }
            
            // ============================================================
            // BUILD COMPLETE JSON PAYLOAD
            // ============================================================
            const payload = {
              ...allFields,
              
              // Add/override processed fields
              catalog_item: catalogItem,
              case_type: finalCaseType,
              priority: finalPriority,
              u_project_environment: finalEnvironment,
              
              // Add metadata fields
              title: issue.title,
              issue_number: issue.number.toString(),
              issue_url: issue.html_url,
              github_user: issue.user.login,
              repository_full_name: context.repo.owner + '/' + context.repo.repo,
              labels: context.payload.issue.labels.map(l => l.name).join(', '),
              project: '${{ env.SERVICENOW_PROJECT }}',
              product: '${{ env.SERVICENOW_PRODUCT }}'
            };
            
            // Output as single JSON string
            const jsonPayload = JSON.stringify(payload);
            core.setOutput('payload', jsonPayload);
            
            // Keep individual outputs for comment step
            core.setOutput('catalog_item', catalogItem);
            core.setOutput('case_type', finalCaseType);
            core.setOutput('priority', finalPriority);
            core.setOutput('u_project_environment', finalEnvironment);
            
            console.log('\n‚úÖ Complete');
            console.log('Fields:', Object.keys(payload).length);

      # ============================================================
      # Send to ServiceNow
      # ============================================================
      - name: Send to ServiceNow
        id: send_servicenow
        run: |
          echo "üì§ Sending to ServiceNow..."
          
          # Payload is already complete from parse step
          PAYLOAD='${{ steps.parse.outputs.payload }}'
          
          # Show preview
          echo "üìÑ Payload preview:"
          echo "$PAYLOAD" | jq '.' || echo "$PAYLOAD"
          
          # Send request
          HTTP_CODE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-WSO2/1.0" \
            -d "$PAYLOAD" \
            -w "%{http_code}" \
            -o response.json \
            -s \
            "${{ env.SERVICENOW_URL }}")

          echo ""
          echo "üì• HTTP Status: $HTTP_CODE"
          echo "üì• Response:"
          cat response.json | jq '.' || cat response.json
          
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            CASE_NUMBER=$(cat response.json | jq -r '.result.case_number // empty')
            echo "case_number=$CASE_NUMBER" >> $GITHUB_OUTPUT
            echo "‚úÖ Success: $CASE_NUMBER"
            exit 0
          else
            echo "‚ùå Failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      # ============================================================
      # Comment on success
      # ============================================================
      - name: Comment on Issue - Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let response = {};
            
            try {
              response = JSON.parse(fs.readFileSync('response.json', 'utf8'));
              if (response.result) response = response.result;
            } catch (e) {}
            
            const caseNumber = response.case_number || 'Unknown';
            const caseType = '${{ steps.parse.outputs.case_type }}';
            const catalogItem = '${{ steps.parse.outputs.catalog_item }}';
            const priority = '${{ steps.parse.outputs.priority }}';
            const environments = '${{ steps.parse.outputs.u_project_environment }}';
            
            const commentBody = `## ‚úÖ ServiceNow Case Created Successfully

            **Case Number:** \`${caseNumber}\`

            ### Request Details
            - **Type:** ${caseType}
            - **Catalog:** ${catalogItem}
            - **Priority:** ${priority}
            - **Environments:** ${environments}

            ### Auto-Mapped Fields
            - **Project:** ${{ env.SERVICENOW_PROJECT }}
            - **Product:** ${{ env.SERVICENOW_PRODUCT }}

            ---
            *Your ${caseType.toLowerCase()} has been submitted and will be processed by the support team.*

            *Automated via GitHub Actions*`;
                        
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body: commentBody
                        });

                  - name: Comment on Issue - Failure
                    if: failure()
                    uses: actions/github-script@v7
                    with:
                      script: |
                        const commentBody = `## ‚ùå ServiceNow Case Creation Failed

            Failed to create case in ServiceNow.

            **Debug Information:**
            - **Catalog:** ${{ steps.parse.outputs.catalog_item }}
            - **Case Type:** ${{ steps.parse.outputs.case_type }}

            Check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for detailed error messages.

            ---
            *Contact support if the issue persists. Reference issue #${context.issue.number}*`;
                        
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body: commentBody
                        });