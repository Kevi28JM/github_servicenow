name: ServiceNow CR Webhook Receiver

on:
  repository_dispatch:
    types: [servicenow-cr-update]

permissions:
  issues: write

jobs:
  update-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Process CR Update
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Received ServiceNow CR update webhook');
            console.log('Payload:', JSON.stringify(context.payload.client_payload, null, 2));
            
            const payload = context.payload.client_payload;
            
            const crNumber = payload.cr_number;
            const crSysId = payload.cr_sys_id;
            const crState = payload.cr_state;
            const caseNumber = payload.case_number;
            const caseSysId = payload.case_sys_id;
            const githubIssueNumber = payload.github_issue_number;
            const action = payload.action;
            const previousState = payload.previous_state;
            const isFirstCR = payload.is_first_cr;
            const totalCRs = payload.total_crs || 1;
            
            if (!githubIssueNumber || !crNumber) {
              console.log('Missing required data in webhook');
              return;
            }
            
            const servicenowUiUrl = '${{ secrets.SERVICENOW_UI_URL }}';
            //build the clickable URL for the CR
            const crUrl = `${servicenowUiUrl}/now/nav/ui/classic/params/target/change_request.do?sys_id=${crSysId}`;
            
            // ============================================
            // HANDLE CR CREATION - ALWAYS CREATE NEW COMMENT
            // ============================================
            if (action === 'created') {
              console.log('Creating new comment for CR creation');
              
              // Query ServiceNow for all CRs to show in the comment
              const servicenowCustomUrl = '${{ secrets.SERVICENOW_URL }}';
              const servicenowBaseUrl = servicenowCustomUrl.replace(/\/api\/.*/, '');
              const servicenowUsername = '${{ secrets.SERVICENOW_USERNAME }}';
              const servicenowPassword = '${{ secrets.SERVICENOW_PASSWORD }}';
              
              const auth = Buffer.from(`${servicenowUsername}:${servicenowPassword}`).toString('base64');
              
              const queryUrl = `${servicenowBaseUrl}/api/now/table/task?sysparm_query=parent=${caseSysId}^sys_class_name=change_request&sysparm_fields=number,state,sys_id&sysparm_display_value=true&sysparm_limit=50`;
              
              console.log('Querying ServiceNow for all CRs...');
              const response = await fetch(queryUrl, {
                headers: {
                  'Authorization': `Basic ${auth}`,
                  'Accept': 'application/json'
                }
              });
              
              let allCRs = [];
              if (response.ok) {
                const data = await response.json();
                allCRs = data.result || [];
                console.log(`Found ${allCRs.length} total CRs`);
              } else {
                console.log(`Failed to query ServiceNow: ${response.status}`);
                // Fallback to just the current CR if query fails
                allCRs = [{
                  number: crNumber,
                  sys_id: crSysId,
                  state: crState
                }];
              }
              
              // Build CR list for the comment
              let crListMarkdown = '';
              if (allCRs.length > 0) {
                crListMarkdown = allCRs.map(cr => 
                  `- [${cr.number}](${servicenowUiUrl}/now/nav/ui/classic/params/target/change_request.do?sys_id=${cr.sys_id}) - ${cr.state || 'Unknown'}`
                ).join('\n');
              } else {
                crListMarkdown = `- [${crNumber}](${crUrl}) - ${crState}`;
              }
              
              // Create new comment
              const newCommentBody = `## New Change Request Created

            **CR Number:** [${crNumber}](${crUrl})
            **State:** ${crState}

            ### All Change Requests for this Case (${allCRs.length})
            ${crListMarkdown}

            ---
            *Automatically notified by ServiceNow*`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(githubIssueNumber),
                body: newCommentBody
              });
              
              console.log(`Created new comment for CR ${crNumber}`);
            }
            
            // ============================================
            // HANDLE STATE CHANGES - CREATE NEW COMMENT
            // ============================================
            else if (action === 'state_changed') {
              console.log('Creating new comment for CR state change');
              
              const stateChangeComment = `## Change Request State Updated

            **CR Number:** [${crNumber}](${crUrl})
            **State Change:** ${previousState} â†’ **${crState}**

            ---
            *Automatically notified by ServiceNow*`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(githubIssueNumber),
                body: stateChangeComment
              });
              
              console.log(`Created new comment for CR ${crNumber} state change`);
            }